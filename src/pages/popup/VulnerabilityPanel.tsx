// src/pages/popup/VulnerabilityPanel.tsx
import React, { useState, useEffect, useMemo } from 'react';
import { CodeSolutionPanel } from './CodeSolutionPanel';
import { InfoTooltip } from './InfoTooltip';
import { startActiveScan } from '../../utils/zapApi';

// Define the structure of a single Alert object from the ZAP API
export interface Alert {
  pluginId?: number; // ZAP plugin ID for reliable template matching
  name: string;
  description: string;
  solution: string;
  url: string;
  risk: 'High' | 'Medium' | 'Low' | 'Informational';
  confidence: 'High' | 'Medium' | 'Low' | 'False Positive';
  param: string;
  evidence: string;
  cweid?: string; // Common Weakness Enumeration ID
  wascid?: string; // Web Application Security Consortium ID
}

// Define the structure for an individual alert occurrence
export interface AlertInstance {
  url: string;
  param: string;
  evidence: string;
}

// Define the new structure for a grouped alert
export interface GroupedAlert {
  pluginId?: number; // ZAP plugin ID for reliable template matching
  name: string;
  description: string;
  solution: string;
  risk: 'High' | 'Medium' | 'Low' | 'Informational';
  confidence: 'High' | 'Medium' | 'Low' | 'False Positive';
  cweid?: string;
  wascid?: string;
  instances: AlertInstance[];
}

// Define the props for the VulnerabilityPanel component
interface VulnerabilityPanelProps {
  alerts: GroupedAlert[];
  onBackToScanner?: () => void;
  onViewDashboard: () => void; // New prop for Dashboard navigation
  host: string;   // Need these for Verify Fix
  apiKey: string; // Need these for Verify Fix
}

export interface CodeSolution {
  solution_description: string;
  affected_files: string;
  code: string;
}

interface VulnerabilityTemplate {
  pluginId?: number; // ZAP plugin ID for reliable matching
  title: string;
  simplified_description: string;
  simplified_solution: string;
  code_solution_samples?: CodeSolution[]; // Array of code solutions (fixed from singular)
}

// A simple modal component to display all URLs
const UrlListModal: React.FC<{ instances: AlertInstance[], onClose: () => void }> = ({ instances, onClose }) => {
  return (
    <div className="absolute inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
      <div className="bg-slate-800 p-4 rounded-lg w-full max-w-md max-h-[90%] flex flex-col shadow-lg border border-slate-700">
        <h3 className="text-lg font-bold mb-3 text-cyan-300 border-b border-slate-600 pb-2">Affected URLs</h3>
        <ul className="flex-grow overflow-y-auto pr-2 custom-scrollbar-thin" style={{
          scrollbarWidth: 'thin',
          scrollbarColor: '#10b981 #1e293b'
        }}>
          {instances.map((instance, index) => (
            <li key={index} className="mb-2 p-2 bg-slate-700 rounded text-xs break-all shadow-sm">
              <p className="font-semibold text-slate-300">URL:</p>
              <p className="text-slate-400">{instance.url}</p>
              {instance.param && <p className="mt-1"><span className="font-semibold text-slate-300">Param:</span> <span className="text-slate-400">{instance.param}</span></p>}
            </li>
          ))}
        </ul>
        <button
          onClick={onClose}
          className="mt-4 w-full p-2.5 border-none rounded bg-cyan-600 text-white text-sm font-semibold cursor-pointer transition-colors hover:bg-cyan-700">
          Close
        </button>
      </div>
    </div>
  );
};

// Fuzzy string matching function using Levenshtein distance
const calculateSimilarity = (str1: string, str2: string): number => {
  const s1 = str1.toLowerCase().trim();
  const s2 = str2.toLowerCase().trim();

  if (s1 === s2) return 1.0;
  if (s1.length === 0 || s2.length === 0) return 0.0;

  const longer = s1.length > s2.length ? s1 : s2;
  const shorter = s1.length > s2.length ? s2 : s1;

  if (longer.length === 0) return 1.0;

  const distance = levenshteinDistance(longer, shorter);
  return (longer.length - distance) / longer.length;
};

// Levenshtein distance algorithm
const levenshteinDistance = (str1: string, str2: string): number => {
  const matrix = Array(str2.length + 1).fill(null).map(() => Array(str1.length + 1).fill(null));

  for (let i = 0; i <= str1.length; i++) matrix[0][i] = i;
  for (let j = 0; j <= str2.length; j++) matrix[j][0] = j;

  for (let j = 1; j <= str2.length; j++) {
    for (let i = 1; i <= str1.length; i++) {
      const indicator = str1[i - 1] === str2[j - 1] ? 0 : 1;
      matrix[j][i] = Math.min(
        matrix[j][i - 1] + 1,        // deletion
        matrix[j - 1][i] + 1,        // insertion
        matrix[j - 1][i - 1] + indicator // substitution
      );
    }
  }

  return matrix[str2.length][str1.length];
};

// Enhanced template matching with logging and fuzzy fallback
const findTemplateMatch = (alert: GroupedAlert, templates: VulnerabilityTemplate[]): {
  template?: VulnerabilityTemplate;
  matchType: 'pluginId' | 'exact' | 'fuzzy' | 'none';
  matchDetails: string;
} => {
  const matchingLog = {
    alert: { name: alert.name, pluginId: alert.pluginId },
    templateCount: templates.length,
    attempts: [] as any[]
  };

  // Priority 1: Match by pluginId (most reliable)
  if (alert.pluginId) {
    const pluginIdMatch = templates.find(t => t.pluginId === alert.pluginId);
    if (pluginIdMatch) {
      return {
        template: pluginIdMatch,
        matchType: 'pluginId',
        matchDetails: `Matched by pluginId: ${alert.pluginId} â†’ "${pluginIdMatch.title}"`
      };
    }
  }

  // Priority 2: Exact title matching
  const exactMatch = templates.find(t => t.title === alert.name);
  if (exactMatch) {
    return {
      template: exactMatch,
      matchType: 'exact',
      matchDetails: `Matched by exact title: "${alert.name}"`
    };
  }

  // Priority 3: Fuzzy string matching
  const FUZZY_THRESHOLD = 0.85;
  let bestMatch: VulnerabilityTemplate | undefined;
  let bestSimilarity = 0;

  templates.forEach(template => {
    const similarity = calculateSimilarity(alert.name, template.title);
    if (similarity > bestSimilarity && similarity >= FUZZY_THRESHOLD) {
      bestSimilarity = similarity;
      bestMatch = template;
    }
  });

  if (bestMatch) {
    return {
      template: bestMatch,
      matchType: 'fuzzy',
      matchDetails: `Fuzzy match: "${alert.name}" â†’ "${bestMatch.title}" (${Math.round(bestSimilarity * 100)}% similar)`
    };
  }

  return {
    template: undefined,
    matchType: 'none',
    matchDetails: `No template found for "${alert.name}"`
  };
};

export const VulnerabilityPanel: React.FC<VulnerabilityPanelProps> = ({
  alerts, onBackToScanner, onViewDashboard, host, apiKey
}) => {
  const [currentIndex, setCurrentIndex] = useState(0);
  const [isUrlsVisible, setUrlsVisible] = useState(false);
  const [showSimplifiedDesc, setShowSimplifiedDesc] = useState(false);
  const [showSimplifiedSol, setShowSimplifiedSol] = useState(false);
  const [showCodeSolution, setShowCodeSolution] = useState(false);
  const [templates, setTemplates] = useState<VulnerabilityTemplate[]>([]);
  const [verifyingUrl, setVerifyingUrl] = useState<string | null>(null);

  const alert = alerts[currentIndex];
  const primaryInstance = alert.instances[0];

  // --- MEMOIZATION: Optimize Template Matching ---
  const templateMatchInfo = useMemo(() => {
    if (templates.length === 0) return { matchType: 'none' as const, matchDetails: 'No templates' };
    return findTemplateMatch(alert, templates);
  }, [alert, templates]);

  const template = templateMatchInfo.template;
  const templateStatus = templateMatchInfo.matchType;

  // --- FUNCTION: Verify Fix ---
  const handleVerifyFix = async () => {
    setVerifyingUrl(primaryInstance.url);
    try {
      // Start a non-recursive active scan on just this URL
      await startActiveScan(host, apiKey, primaryInstance.url, false);
      // Use standard browser alert for simplicity in popup or a notification system
      window.alert('Verification Scan Started! Check the ZAP Scanner tab for progress.');
    } catch (e) {
      const msg = e instanceof Error ? e.message : String(e);
      window.alert('Failed to start verification: ' + msg);
    } finally {
      setVerifyingUrl(null);
    }
  };

  // --- FUNCTION: Copy as Markdown ---
  const handleCopyMarkdown = async () => {
    const text = `
### [${alert.risk}] ${alert.name}
**URL:** ${primaryInstance.url}
**Description:** ${alert.description}
**Solution:** ${alert.solution}
    `.trim();

    try {
      await navigator.clipboard.writeText(text);
    } catch (e) {
      console.error("Copy failed", e);
    }
  };


  useEffect(() => {
    fetch(chrome.runtime.getURL('vulnerability_templates.json'))
      .then((response) => response.json())
      .then((data) => {
        setTemplates(data);
      })
      .catch((error) => {
        console.error("âŒ Failed to load vulnerability templates:", error);
      });
  }, []);

  // Add custom scrollbar styles + explicit font
  useEffect(() => {
    const style = document.createElement('style');
    style.textContent = `
      .custom-scrollbar::-webkit-scrollbar { width: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; border-radius: 3px; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #06b6d4; border-radius: 3px; border: 1px solid #0e7490; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #0891b2; }

      .custom-scrollbar-thin::-webkit-scrollbar { width: 4px; }
      .custom-scrollbar-thin::-webkit-scrollbar-track { background: #1e293b; border-radius: 2px; }
      .custom-scrollbar-thin::-webkit-scrollbar-thumb { background: #10b981; border-radius: 2px; border: 1px solid #059669; }
      .custom-scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #059669; }

      @import url('${chrome.runtime.getURL('Font/MerriweatherSans-Regular.ttf')}');
      .merriweather-font { font-family: 'Merriweather Sans', sans-serif; }
    `;
    document.head.appendChild(style);
    return () => { document.head.removeChild(style); };
  }, []);

  const handleNext = () => {
    setUrlsVisible(false);
    setShowCodeSolution(false);
    setCurrentIndex((prev) => Math.min(prev + 1, alerts.length - 1));
  };

  const handlePrevious = () => {
    setUrlsVisible(false);
    setShowCodeSolution(false);
    setCurrentIndex((prev) => Math.max(prev - 1, 0));
  };

  // Helper functions for colors
  const getRiskColor = (risk: string) => {
    switch (risk.toLowerCase()) {
      case 'high': return 'text-red-400 bg-red-900/30 border-red-700';
      case 'medium': return 'text-yellow-400 bg-yellow-900/30 border-yellow-700';
      case 'low': return 'text-blue-400 bg-blue-900/30 border-blue-700';
      case 'informational': return 'text-green-400 bg-green-900/30 border-green-700';
      default: return 'text-slate-400 bg-slate-900/30 border-slate-700';
    }
  };

  const getConfidenceColor = (confidence: string) => {
    switch (confidence.toLowerCase()) {
      case 'high': return 'text-cyan-400';
      case 'medium': return 'text-yellow-400';
      case 'low': return 'text-orange-400';
      case 'false positive': return 'text-red-400';
      default: return 'text-slate-400';
    }
  };

  const parseCweId = (cweId?: string): string | null => {
    if (!cweId || cweId === 'N/A' || cweId === '0') return null;
    const match = cweId.match(/(\d+)/);
    return match ? match[1] : null;
  };

  const DetailItem = ({ label, value, tooltipText, isRisk, isConfidence, isCwe }: any) => {
    if (!value) return null;
    return (
      <div className="flex items-start">
        <div className="flex items-center w-24 flex-shrink-0">
          <strong className="text-cyan-400 font-medium">{label}:</strong>
          {tooltipText && <InfoTooltip text={tooltipText} />}
        </div>
        {isRisk ? (
          <span className={`px-2 py-1 rounded text-xs font-medium border ${getRiskColor(value)}`}>{value}</span>
        ) : isConfidence ? (
          <span className={`px-2 py-1 rounded text-xs font-medium bg-slate-700 ${getConfidenceColor(value)}`}>{value}</span>
        ) : isCwe ? (
          parseCweId(value) ? (
            <button
              onClick={() => {
                const id = parseCweId(value);
                if (id) chrome.tabs.create({ url: `https://cwe.mitre.org/data/definitions/${id}.html`, active: false });
              }}
              className="text-cyan-400 hover:underline break-all text-left bg-transparent border-none p-0 cursor-pointer font-inherit"
              title="Open CWE definition in background tab"
            >{value}</button>
          ) : <span className="text-slate-300 break-all">{value}</span>
        ) : (
          <span className="text-slate-300 break-all">{value}</span>
        )}
      </div>
    );
  };

  if (showCodeSolution && template?.code_solution_samples) {
    return <CodeSolutionPanel solutions={template.code_solution_samples} onBack={() => setShowCodeSolution(false)} />;
  }

  return (
    <div className="w-full h-full flex flex-col p-3 bg-slate-900 text-slate-200 relative">
      {isUrlsVisible && <UrlListModal instances={alert.instances} onClose={() => setUrlsVisible(false)} />}

      <header className="flex-shrink-0 pb-2 border-b border-slate-700">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <img src={chrome.runtime.getURL('Icons/Github-Octicons-Code-review-16.512.png')} alt="ZAP Logo" className="w-7 h-7 brightness-0 invert" />
            <span className="text-lg font-bold merriweather-font">ZAPatchex</span>
          </div>

          {/* Navigation Buttons */}
          <div className="flex gap-1 items-center">
            <button onClick={onViewDashboard} className="px-2 py-1 bg-slate-700 text-xs rounded hover:bg-slate-600 text-cyan-300 mr-2">
              Dashboard
            </button>

            <button onClick={() => chrome.tabs.create({ url: 'http://localhost:8080' })} className="p-1.5 text-slate-400 hover:text-white hover:bg-slate-700 rounded-md" title="Go to ZAP">
              <img src={chrome.runtime.getURL('Icons/open_icon-icons.com_72303.png')} alt="Open ZAP" className="w-5 h-5 brightness-0 invert" />
            </button>
            <button onClick={onBackToScanner} className="p-1.5 text-slate-400 hover:text-white hover:bg-slate-700 rounded-md" title="Back to Homepage">
              <img src={chrome.runtime.getURL('Icons/icons8-home-50.png')} alt="Back to Homepage" className="w-5 h-5 brightness-0 invert" />
            </button>
          </div>
        </div>
        <h2 className="text-xl font-bold text-center mt-2 text-white merriweather-font truncate" title={alert.name}>{alert.name}</h2>
      </header>

      <main className="flex-grow overflow-y-auto py-2 text-sm space-y-3 custom-scrollbar" style={{ scrollbarWidth: 'thin', scrollbarColor: '#06b6d4 #1e293b' }}>

        {/* NEW: Verify Fix Section */}
        <div className="bg-slate-800 p-3 rounded-lg space-y-1 text-xs">
          <div className="grid grid-cols-2 gap-x-6 gap-y-1">
            <DetailItem label="Risk" value={alert.risk} isRisk={true} />
            <DetailItem label="Confidence" value={alert.confidence} tooltipText="The level of confidence." isConfidence={true} />
            <DetailItem label="CWE ID" value={alert.cweid} isCwe={true} />
            <DetailItem label="WASC ID" value={alert.wascid} />
          </div>
          <hr className="border-slate-700 my-2" />
          <div className="flex items-center justify-between">
            <div className="flex items-start overflow-hidden flex-grow mr-2">
              <strong className="text-cyan-400 font-medium w-12 flex-shrink-0">URL:</strong>
              <span className="text-slate-300 break-all truncate">{primaryInstance.url}</span>
            </div>
            <button
              onClick={handleVerifyFix}
              disabled={!!verifyingUrl}
              className="px-2 py-1 bg-purple-600 text-white rounded text-xs hover:bg-purple-700 disabled:opacity-50 flex-shrink-0 font-bold shadow-sm"
              title="Run a quick active scan on this specific URL"
            >
              {verifyingUrl ? 'Scanning...' : 'Verify Fix'}
            </button>
          </div>
          <DetailItem label="Parameter" value={primaryInstance.param} />
          <DetailItem label="Evidence" value={primaryInstance.evidence} />
        </div>

        {/* Description Section */}
        <div className="bg-slate-800 p-3 rounded-lg">
          <div className="flex items-center justify-between mb-1.5">
            <div className="flex items-center gap-2">
              <h4 className="text-md font-bold text-cyan-400">Description</h4>
              <div className="flex items-center text-xs"> {/* Template Status Pills */}
                {templateStatus === 'pluginId' && <span className="px-2 py-0.5 bg-green-600 text-white rounded-full">Template (ID)</span>}
                {templateStatus === 'exact' && <span className="px-2 py-0.5 bg-blue-600 text-white rounded-full">Template Match</span>}
                {templateStatus === 'fuzzy' && <span className="px-2 py-0.5 bg-yellow-600 text-white rounded-full">Fuzzy Match</span>}
              </div>
            </div>
            {template?.simplified_description && (
              <div className="flex items-center text-xs rounded-lg p-0.5 bg-slate-800 shadow-inner">
                <button onClick={() => setShowSimplifiedDesc(false)} className={`px-2 py-0.5 rounded-md ${!showSimplifiedDesc ? 'bg-blue-500 text-white' : 'text-slate-300'}`}>Standard</button>
                <button onClick={() => setShowSimplifiedDesc(true)} className={`px-2 py-0.5 rounded-md ${showSimplifiedDesc ? 'bg-emerald-500 text-white' : 'text-slate-300'}`}>Simplified</button>
              </div>
            )}
          </div>
          <p className="whitespace-pre-wrap text-xs text-slate-300">
            {showSimplifiedDesc && template?.simplified_description ? template.simplified_description : alert.description}
          </p>
        </div>

        {/* Solution Section */}
        <div className="bg-slate-800 p-3 rounded-lg">
          <div className="flex items-center justify-between mb-1.5">
            <h4 className="text-md font-bold text-cyan-400">Solution</h4>
            {template?.simplified_solution && (
              <div className="flex items-center text-xs rounded-lg p-0.5 bg-slate-800 shadow-inner">
                <button onClick={() => setShowSimplifiedSol(false)} className={`px-2 py-0.5 rounded-md ${!showSimplifiedSol ? 'bg-blue-500 text-white' : 'text-slate-300'}`}>Standard</button>
                <button onClick={() => setShowSimplifiedSol(true)} className={`px-2 py-0.5 rounded-md ${showSimplifiedSol ? 'bg-emerald-500 text-white' : 'text-slate-300'}`}>Simplified</button>
              </div>
            )}
          </div>
          <p className="whitespace-pre-wrap text-xs text-slate-300">
            {showSimplifiedSol && template?.simplified_solution ? template.simplified_solution : alert.solution}
          </p>
        </div>

        {/* Action Buttons */}
        <div className="flex gap-2">
          <button
            onClick={handleCopyMarkdown}
            className="flex-1 p-2 rounded bg-slate-700 border border-slate-600 hover:bg-slate-600 text-xs font-semibold text-white transition-colors"
          >
            Copy MD
          </button>
          {template?.code_solution_samples && template.code_solution_samples.length > 0 && (
            <button
              onClick={() => setShowCodeSolution(true)}
              className="flex-[2] p-2 rounded bg-teal-600 hover:bg-teal-700 text-white text-xs font-semibold flex items-center justify-center gap-2"
            >
              View Code Fix ({template.code_solution_samples.length})
            </button>
          )}
        </div>

      </main>

      <footer className="flex-shrink-0 flex items-center justify-between pt-2 border-t border-slate-700">
        <button onClick={handlePrevious} disabled={currentIndex === 0} className="w-auto p-2 rounded-md disabled:opacity-25 hover:enabled:bg-slate-700">
          ðŸ¡„ Prev
        </button>
        <span className="text-xs font-medium">{currentIndex + 1} / {alerts.length}</span>
        <button onClick={handleNext} disabled={currentIndex === alerts.length - 1} className="w-auto p-2 rounded-md disabled:opacity-25 hover:enabled:bg-slate-700">
          Next ðŸ¡†
        </button>
      </footer>
    </div>
  );
};