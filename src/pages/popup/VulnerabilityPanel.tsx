// src/pages/popup/VulnerabilityPanel.tsx
import React, { useState, useEffect, useMemo } from 'react';
import { CodeSolutionPanel } from './CodeSolutionPanel';
import { InfoTooltip } from './InfoTooltip';
import { getSites } from '../../utils/zapApi';

export interface Alert {
  pluginId?: number;
  name: string;
  description: string;
  solution: string;
  url: string;
  risk: 'High' | 'Medium' | 'Low' | 'Informational';
  confidence: 'High' | 'Medium' | 'Low' | 'False Positive';
  param: string;
  evidence: string;
  cweid?: string;
  wascid?: string;
}

export interface AlertInstance {
  url: string;
  param: string;
  evidence: string;
}

export interface GroupedAlert {
  pluginId?: number;
  name: string;
  description: string;
  solution: string;
  risk: 'High' | 'Medium' | 'Low' | 'Informational';
  confidence: 'High' | 'Medium' | 'Low' | 'False Positive';
  cweid?: string;
  wascid?: string;
  instances: AlertInstance[];
}

interface VulnerabilityPanelProps {
  alerts: GroupedAlert[];
  onBackToScanner?: () => void;
  onViewDashboard: () => void;
  host: string;
  apiKey: string;
  selectedSite: string;
  onSiteSelect: (site: string) => void;
}

export interface CodeSolution {
  type?: string;
  solution_description: string;
  affected_files: string;
  code: string;
}

interface VulnerabilityTemplate {
  pluginId: number;
  title: string;
  title_pattern?: string;
  defaultRisk?: string;
  cweid?: string | number;
  description: string;
  simplified_description: string;
  solution: string;
  simplified_solution: string;
  references: { name: string; url: string }[];
  code_solution_samples: CodeSolution[];
}

const hydrateCodeTemplate = (code: string, instance: AlertInstance): string => {
  let hydratedCode = code;
  const paramName = instance.param || 'input_param';
  hydratedCode = hydratedCode.replace(/{{param}}/g, paramName);
  const evidence = instance.evidence ? instance.evidence.replace(/"/g, '\\"') : 'malicious_input';
  hydratedCode = hydratedCode.replace(/{{evidence}}/g, evidence);
  hydratedCode = hydratedCode.replace(/{{url}}/g, instance.url);
  try {
    const urlObj = new URL(instance.url);
    const filename = urlObj.pathname.split('/').pop() || 'script';
    hydratedCode = hydratedCode.replace(/{{filename}}/g, filename);
  } catch (e) {
    hydratedCode = hydratedCode.replace(/{{filename}}/g, 'script');
  }
  return hydratedCode;
};

// --- STYLISH MODAL WITH PAGINATION ---
const UrlListModal: React.FC<{ instances: AlertInstance[], onClose: () => void }> = ({ instances, onClose }) => {
  const [visibleCount, setVisibleCount] = useState(20);
  const visibleInstances = instances.slice(0, visibleCount);

  const handleShowMore = () => {
    setVisibleCount(prev => Math.min(prev + 50, instances.length));
  };

  return (
    <div className="absolute inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm animate-fade-in">
      {/* Modal Container */}
      <div className="w-full max-w-md bg-slate-800 rounded-xl shadow-2xl border border-slate-600 overflow-hidden relative flex flex-col max-h-[85%] transform transition-all scale-100">

        {/* Decorative Background Blur */}
        <div className="absolute top-0 right-0 w-32 h-32 bg-cyan-500/10 rounded-full blur-2xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>

        {/* Header */}
        <div className="flex justify-between items-center p-4 border-b border-slate-700 bg-slate-800/95 relative z-10">
          <div>
            <h3 className="text-md font-bold text-white tracking-wide">Affected URLs</h3>
            <p className="text-[10px] text-slate-400 mt-0.5 font-mono">
              Total Instances: <span className="text-cyan-400">{instances.length}</span>
            </p>
          </div>
          <button
            onClick={onClose}
            className="p-1.5 rounded-full hover:bg-slate-700 text-slate-400 hover:text-white transition-colors"
          >
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>
          </button>
        </div>

        {/* Scrollable List */}
        <div
          className="flex-grow overflow-y-auto p-3 space-y-2 bg-slate-900/30"
          style={{
            scrollbarWidth: 'thin',
            scrollbarColor: '#334155 transparent'
          }}
        >
          {visibleInstances.map((instance, index) => (
            <div key={index} className="group p-2.5 rounded-lg border border-slate-700/50 bg-slate-800/50 hover:bg-slate-700/50 hover:border-cyan-500/30 transition-all duration-200">
              <div className="flex items-start gap-2 overflow-hidden">
                <div className="mt-0.5 min-w-[16px]">
                  <svg className="w-3.5 h-3.5 text-cyan-500/70 group-hover:text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                  </svg>
                </div>
                <div className="flex-1 min-w-0">
                  <p className="text-xs text-slate-300 break-all leading-relaxed font-mono select-all">
                    {instance.url}
                  </p>
                  {instance.param && (
                    <div className="mt-1.5 flex items-center gap-1.5">
                      <span className="text-[9px] uppercase tracking-wider font-bold text-slate-500">Param</span>
                      <span className="px-1.5 py-0.5 rounded text-[10px] font-mono bg-red-900/20 text-red-300 border border-red-900/30">
                        {instance.param}
                      </span>
                    </div>
                  )}
                </div>
              </div>
            </div>
          ))}

          {visibleCount < instances.length && (
            <button
              onClick={handleShowMore}
              className="w-full py-2 text-xs text-slate-400 hover:text-white hover:bg-slate-700/50 rounded-lg transition-colors border border-dashed border-slate-700 mt-2"
            >
              Load {Math.min(50, instances.length - visibleCount)} more...
            </button>
          )}
        </div>

        {/* Footer Actions */}
        <div className="p-3 border-t border-slate-700 bg-slate-800/95 relative z-10">
          <button
            onClick={onClose}
            className="w-full py-2 rounded-lg bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white text-xs font-bold shadow-lg shadow-cyan-900/20 transition-all active:scale-[0.98]"
          >
            Close List
          </button>
        </div>
      </div>
    </div>
  );
};

const calculateSimilarity = (str1: string, str2: string): number => {
  const s1 = str1.toLowerCase().trim();
  const s2 = str2.toLowerCase().trim();
  if (s1 === s2) return 1.0;
  if (s1.length === 0 || s2.length === 0) return 0.0;
  const longer = s1.length > s2.length ? s1 : s2;
  const shorter = s1.length > s2.length ? s2 : s1;
  if (longer.length === 0) return 1.0;
  const distance = levenshteinDistance(longer, shorter);
  return (longer.length - distance) / longer.length;
};

const levenshteinDistance = (str1: string, str2: string): number => {
  const matrix = Array(str2.length + 1).fill(null).map(() => Array(str1.length + 1).fill(null));
  for (let i = 0; i <= str1.length; i++) matrix[0][i] = i;
  for (let j = 0; j <= str2.length; j++) matrix[j][0] = j;
  for (let j = 1; j <= str2.length; j++) {
    for (let i = 1; i <= str1.length; i++) {
      const indicator = str1[i - 1] === str2[j - 1] ? 0 : 1;
      matrix[j][i] = Math.min(
        matrix[j][i - 1] + 1,
        matrix[j - 1][i] + 1,
        matrix[j - 1][i - 1] + indicator
      );
    }
  }
  return matrix[str2.length][str1.length];
};

const findTemplateMatch = (alert: GroupedAlert, templates: VulnerabilityTemplate[]): {
  template?: VulnerabilityTemplate;
  matchType: 'pluginId' | 'pattern' | 'exact' | 'fuzzy' | 'none';
  matchDetails: string;
} => {
  if (alert.pluginId) {
    const idCandidates = templates.filter(t => t.pluginId === alert.pluginId);
    if (idCandidates.length > 0) {
      for (const candidate of idCandidates) {
        if (candidate.title_pattern) {
          try {
            const regex = new RegExp(candidate.title_pattern, 'i');
            if (regex.test(alert.name)) {
              return { template: candidate, matchType: 'pattern', matchDetails: `Matched by ID & Pattern: "${candidate.title_pattern}"` };
            }
          } catch (e) { console.error(`Invalid regex:`, e); }
        }
      }
      const defaultCandidate = idCandidates.find(t => !t.title_pattern);
      if (defaultCandidate) return { template: defaultCandidate, matchType: 'pluginId', matchDetails: `Matched by pluginId (Default): ${alert.pluginId}` };
      return { template: idCandidates[0], matchType: 'pluginId', matchDetails: `Matched by pluginId (First): ${alert.pluginId}` };
    }
  }
  const exactMatch = templates.find(t => t.title === alert.name);
  if (exactMatch) return { template: exactMatch, matchType: 'exact', matchDetails: `Matched by exact title: "${alert.name}"` };
  const FUZZY_THRESHOLD = 0.85;
  let bestMatch: VulnerabilityTemplate | undefined;
  let bestSimilarity = 0;
  templates.forEach(template => {
    const similarity = calculateSimilarity(alert.name, template.title);
    if (similarity > bestSimilarity && similarity >= FUZZY_THRESHOLD) {
      bestSimilarity = similarity;
      bestMatch = template;
    }
  });
  if (bestMatch) return { template: bestMatch, matchType: 'fuzzy', matchDetails: `Fuzzy match: (${Math.round(bestSimilarity * 100)}%)` };
  return { template: undefined, matchType: 'none', matchDetails: `No template found` };
};

export const VulnerabilityPanel: React.FC<VulnerabilityPanelProps> = ({
  alerts, onBackToScanner, onViewDashboard, host, apiKey, selectedSite, onSiteSelect
}) => {
  const [currentIndex, setCurrentIndex] = useState(0);
  const [isUrlsVisible, setUrlsVisible] = useState(false);
  const [showSimplifiedDesc, setShowSimplifiedDesc] = useState(false);
  const [showSimplifiedSol, setShowSimplifiedSol] = useState(false);
  const [showCodeSolution, setShowCodeSolution] = useState(false);
  const [templates, setTemplates] = useState<VulnerabilityTemplate[]>([]);
  const [activeRuleIds, setActiveRuleIds] = useState<Set<string>>(new Set());
  const [passiveRuleIds, setPassiveRuleIds] = useState<Set<string>>(new Set());
  const [sites, setSites] = useState<string[]>([]);

  useEffect(() => {
    getSites(host, apiKey).then(setSites).catch(e => console.error(e));
    Promise.all([
      fetch(chrome.runtime.getURL('vulnerability_templates.json')).then(r => r.json()),
      fetch(chrome.runtime.getURL('activescanrules_json.json')).then(r => r.json()).catch(() => ({ scanners: [] })),
      fetch(chrome.runtime.getURL('passivescanrules_json.json')).then(r => r.json()).catch(() => ({ scanners: [] }))
    ])
      .then(([templatesData, activeRulesData, passiveRulesData]) => {
        setTemplates(templatesData);
        const activeIds = new Set<string>();
        if (activeRulesData.scanners && Array.isArray(activeRulesData.scanners)) activeRulesData.scanners.forEach((s: any) => activeIds.add(String(s.id)));
        setActiveRuleIds(activeIds);
        const passiveIds = new Set<string>();
        if (passiveRulesData.scanners && Array.isArray(passiveRulesData.scanners)) passiveRulesData.scanners.forEach((s: any) => passiveIds.add(String(s.id)));
        setPassiveRuleIds(passiveIds);
      })
      .catch((error) => console.error("âŒ Failed to load resources:", error));

    const style = document.createElement('style');
    style.textContent = `
      .custom-scrollbar::-webkit-scrollbar { width: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; border-radius: 3px; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #06b6d4; border-radius: 3px; border: 1px solid #0e7490; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #0891b2; }
      @import url('${chrome.runtime.getURL('Font/MerriweatherSans-Regular.ttf')}');
      .merriweather-font { font-family: 'Merriweather Sans', sans-serif; }
    `;
    document.head.appendChild(style);
    return () => { document.head.removeChild(style); };
  }, [host, apiKey]);

  useEffect(() => {
    if (currentIndex >= alerts.length) setCurrentIndex(0);
  }, [alerts.length, currentIndex]);

  // --- BEAUTIFIED "NO RESULTS" STATE (FILTERED) ---
  if (alerts.length === 0) {
    return (
      <div className="w-full h-full flex flex-col bg-slate-900 text-slate-200 p-3 relative overflow-hidden">
        {/* Decorative BG */}
        <div className="absolute bottom-0 right-0 w-64 h-64 bg-cyan-500/5 rounded-full blur-3xl pointer-events-none translate-y-1/2 translate-x-1/2"></div>

        {/* Header (Preserve Navigation) */}
        <div className="flex items-center gap-2 mb-4 relative z-10">
          <button
            onClick={onBackToScanner}
            className="p-2 rounded bg-slate-800 hover:bg-slate-700 text-slate-400 transition-colors border border-slate-700 shadow-sm"
            title="Back to Scanner"
          >
            <img src={chrome.runtime.getURL('Icons/icons8-home-50.png')} className="w-4 h-4 brightness-0 invert opacity-70" alt="Home" />
          </button>
          <select
            value={selectedSite}
            onChange={(e) => onSiteSelect(e.target.value)}
            className="flex-1 bg-slate-800 border border-slate-700 rounded p-2 text-sm text-white focus:border-cyan-500 outline-none"
          >
            <option value="">All Sites</option>
            {sites.map(s => <option key={s} value={s}>{s}</option>)}
          </select>
        </div>

        {/* Empty State Content */}
        <div className="flex-grow flex flex-col items-center justify-center relative z-10 text-center p-6 pb-20">
          <div className="w-16 h-16 bg-slate-800/50 rounded-full flex items-center justify-center mb-4 border border-dashed border-slate-700 group">
            <svg className="w-8 h-8 text-slate-600 group-hover:text-slate-400 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </div>
          <h3 className="text-sm font-bold text-slate-300 mb-1">No Results for this Filter</h3>
          <p className="text-[10px] text-slate-500 max-w-[200px]">
            We couldn't find any alerts matching the selected site.
            <br /><br />
            Try switching back to <strong>"All Sites"</strong>.
          </p>
        </div>
      </div>
    );
  }

  const alert = alerts[currentIndex];
  const primaryInstance = alert.instances[0];

  const templateMatchInfo = useMemo(() => {
    if (templates.length === 0) return { matchType: 'none' as const, matchDetails: 'No templates' };
    return findTemplateMatch(alert, templates);
  }, [alert, templates]);

  const template = templateMatchInfo.template;
  const templateStatus = templateMatchInfo.matchType;

  const customizedSolutions = useMemo(() => {
    if (!template?.code_solution_samples) return [];
    let detectedLang = 'javascript';
    if (primaryInstance.url.endsWith('.php')) detectedLang = 'php';
    if (primaryInstance.url.endsWith('.jsp')) detectedLang = 'java';
    const solutions = template.code_solution_samples.map(sol => ({
      ...sol,
      code: hydrateCodeTemplate(sol.code, primaryInstance),
      solution_description: hydrateCodeTemplate(sol.solution_description, primaryInstance)
    }));
    return solutions.sort((a, b) => {
      if ((a as any).language === detectedLang) return -1;
      return 1;
    });
  }, [template, primaryInstance]);

  const getScanOrigin = (pluginId?: number): { label: string; color: string; desc: string } => {
    if (!pluginId) return { label: 'Unknown', color: 'bg-slate-600', desc: 'No Plugin ID found' };
    const idStr = String(pluginId);
    if (activeRuleIds.has(idStr)) return { label: 'Active Scan', color: 'bg-purple-600', desc: 'Detected by Active Scanner' };
    if (passiveRuleIds.has(idStr)) return { label: 'Passive Scan', color: 'bg-indigo-600', desc: 'Detected by Passive Scanner' };
    return { label: 'External/Script', color: 'bg-slate-600', desc: 'Script or External Scanner' };
  };

  const scanOrigin = getScanOrigin(alert.pluginId);

  const handleCopyMarkdown = async () => {
    const text = `
### [${alert.risk}] ${alert.name}
**URL:** ${primaryInstance.url}
**Description:** ${alert.description}
**Solution:** ${alert.solution}
    `.trim();
    try { await navigator.clipboard.writeText(text); } catch (e) { console.error("Copy failed", e); }
  };

  const handleNext = () => {
    setUrlsVisible(false);
    setShowCodeSolution(false);
    setCurrentIndex((prev) => Math.min(prev + 1, alerts.length - 1));
  };

  const handlePrevious = () => {
    setUrlsVisible(false);
    setShowCodeSolution(false);
    setCurrentIndex((prev) => Math.max(prev - 1, 0));
  };

  const getRiskColor = (risk: string) => {
    switch (risk.toLowerCase()) {
      case 'high': return 'text-red-400 bg-red-900/30 border-red-700';
      case 'medium': return 'text-yellow-400 bg-yellow-900/30 border-yellow-700';
      case 'low': return 'text-blue-400 bg-blue-900/30 border-blue-700';
      case 'informational': return 'text-green-400 bg-green-900/30 border-green-700';
      default: return 'text-slate-400 bg-slate-900/30 border-slate-700';
    }
  };

  const getConfidenceColor = (confidence: string) => {
    switch (confidence.toLowerCase()) {
      case 'high': return 'text-cyan-400';
      case 'medium': return 'text-yellow-400';
      case 'low': return 'text-orange-400';
      case 'false positive': return 'text-red-400';
      default: return 'text-slate-400';
    }
  };

  const DetailItem = ({ label, value, tooltipText, isRisk, isConfidence }: any) => {
    if (!value) return null;
    return (
      <div className="flex items-start">
        <div className="flex items-center w-24 flex-shrink-0">
          <strong className="text-cyan-400 font-medium">{label}:</strong>
          {tooltipText && <InfoTooltip text={tooltipText} />}
        </div>
        {isRisk ? (
          <span className={`px-2 py-1 rounded text-xs font-medium border ${getRiskColor(value)}`}>{value}</span>
        ) : isConfidence ? (
          <span className={`px-2 py-1 rounded text-xs font-medium bg-slate-700 ${getConfidenceColor(value)}`}>{value}</span>
        ) : (
          <span className="text-slate-300 break-all">{value}</span>
        )}
      </div>
    );
  };

  if (showCodeSolution && customizedSolutions.length > 0) {
    return (
      <CodeSolutionPanel
        solutions={customizedSolutions}
        onBack={() => setShowCodeSolution(false)}
        title={template?.title || alert.name}
        fullDescription={template?.description || alert.description}
        fullSolution={template?.solution || alert.solution}
        references={template?.references}
      />
    );
  }

  return (
    <div className="w-full h-full flex flex-col p-3 bg-slate-900 text-slate-200 relative">
      {isUrlsVisible && <UrlListModal instances={alert.instances} onClose={() => setUrlsVisible(false)} />}

      <header className="flex-shrink-0 pb-2 border-b border-slate-700 space-y-2">
        <div className="flex items-center gap-2">
          <button
            onClick={onBackToScanner}
            className="p-2 rounded bg-slate-800 hover:bg-slate-700 text-slate-400 transition-colors"
            title="Back to Start"
          >
            <img src={chrome.runtime.getURL('Icons/icons8-home-50.png')} className="w-4 h-4 brightness-0 invert opacity-70" alt="Home" />
          </button>

          <div className="flex-grow relative group">
            <select
              value={selectedSite}
              onChange={(e) => {
                onSiteSelect(e.target.value);
                setCurrentIndex(0);
              }}
              className="w-full bg-slate-800 text-xs text-cyan-400 font-semibold py-2 pl-3 pr-6 rounded border border-slate-700 focus:border-cyan-500 outline-none appearance-none truncate cursor-pointer hover:bg-slate-750"
            >
              <option value="">Viewing: All Sites</option>
              {sites.map(s => <option key={s} value={s}>Site: {s}</option>)}
            </select>
            <div className="absolute right-2 top-2.5 pointer-events-none text-slate-500 text-[10px]">â–¼</div>
          </div>

          <button
            onClick={onViewDashboard}
            className="p-2 rounded bg-slate-800 hover:bg-slate-700 text-slate-400 transition-colors"
            title="View Dashboard Charts"
          >
            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" />
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" />
            </svg>
          </button>

          <button
            onClick={() => chrome.tabs.create({ url: 'http://localhost:8080' })}
            className="p-2 rounded bg-slate-800 hover:bg-slate-700 text-slate-400 transition-colors"
            title="Open ZAP Interface"
          >
            <img src={chrome.runtime.getURL('Icons/open_icon-icons.com_72303.png')} className="w-4 h-4 brightness-0 invert opacity-70" alt="Open ZAP" />
          </button>
        </div>

        <h2
          className="text-lg font-bold text-center text-white merriweather-font whitespace-normal break-words leading-tight px-1"
          title={alert.name}
        >
          {alert.name}
        </h2>
      </header>

      {/* FIXED: Applied same specific scrollbar styling (Thin & Bright Blue) */}
      <main
        className="flex-grow overflow-y-auto py-2 text-sm space-y-3 custom-scrollbar"
        style={{
          scrollbarWidth: 'thin',
          scrollbarColor: '#06b6d4 #1e293b' // Cyan-500 thumb / Slate-800 track
        }}
      >

        <div className="bg-slate-800 p-3 rounded-lg space-y-1 text-xs">
          <div className="grid grid-cols-2 gap-x-6 gap-y-1">
            <DetailItem label="Risk" value={alert.risk} isRisk={true} />
            <DetailItem label="Confidence" value={alert.confidence} tooltipText="The level of confidence." isConfidence={true} />
            <DetailItem label="CWE ID" value={alert.cweid} />
            <DetailItem label="WASC ID" value={alert.wascid} />
          </div>
          <hr className="border-slate-700 my-2" />
          <div className="flex items-center justify-between">
            <div className="flex items-start overflow-hidden flex-grow mr-2">
              <strong className="text-cyan-400 font-medium w-12 flex-shrink-0">URL:</strong>
              <span className="text-slate-300 break-all truncate">{primaryInstance.url}</span>
            </div>

            <div
              className={`px-3 py-1 text-white rounded text-xs flex-shrink-0 font-bold shadow-sm ${scanOrigin.color}`}
              title={scanOrigin.desc}
            >
              {scanOrigin.label}
            </div>
          </div>
          <DetailItem label="Parameter" value={primaryInstance.param} />
          <DetailItem label="Evidence" value={primaryInstance.evidence} />
        </div>

        <div className="bg-slate-800 p-3 rounded-lg">
          <div className="flex items-center justify-between mb-1.5">
            <div className="flex items-center gap-2">
              <h4 className="text-md font-bold text-cyan-400">Description</h4>
              <div className="flex items-center text-xs">
                {templateStatus === 'pluginId' && <span className="px-2 py-0.5 bg-green-600 text-white rounded-full">Template (ID)</span>}
                {templateStatus === 'exact' && <span className="px-2 py-0.5 bg-blue-600 text-white rounded-full">Template Match</span>}
                {templateStatus === 'fuzzy' && <span className="px-2 py-0.5 bg-yellow-600 text-white rounded-full">Fuzzy Match</span>}
              </div>
            </div>
            {template?.simplified_description && (
              <div className="flex items-center text-xs rounded-lg p-0.5 bg-slate-800 shadow-inner">
                <button onClick={() => setShowSimplifiedDesc(false)} className={`px-2 py-0.5 rounded-md ${!showSimplifiedDesc ? 'bg-blue-500 text-white' : 'text-slate-300'}`}>Standard</button>
                <button onClick={() => setShowSimplifiedDesc(true)} className={`px-2 py-0.5 rounded-md ${showSimplifiedDesc ? 'bg-emerald-500 text-white' : 'text-slate-300'}`}>Simplified</button>
              </div>
            )}
          </div>
          <p className="whitespace-pre-wrap text-xs text-slate-300">
            {showSimplifiedDesc && template?.simplified_description ? template.simplified_description : alert.description}
          </p>
        </div>

        <div className="bg-slate-800 p-3 rounded-lg">
          <div className="flex items-center justify-between mb-1.5">
            <h4 className="text-md font-bold text-cyan-400">Solution</h4>
            {template?.simplified_solution && (
              <div className="flex items-center text-xs rounded-lg p-0.5 bg-slate-800 shadow-inner">
                <button onClick={() => setShowSimplifiedSol(false)} className={`px-2 py-0.5 rounded-md ${!showSimplifiedSol ? 'bg-blue-500 text-white' : 'text-slate-300'}`}>Standard</button>
                <button onClick={() => setShowSimplifiedSol(true)} className={`px-2 py-0.5 rounded-md ${showSimplifiedSol ? 'bg-emerald-500 text-white' : 'text-slate-300'}`}>Simplified</button>
              </div>
            )}
          </div>
          <p className="whitespace-pre-wrap text-xs text-slate-300">
            {showSimplifiedSol && template?.simplified_solution ? template.simplified_solution : alert.solution}
          </p>
        </div>

        <div className="flex gap-2">
          <button
            onClick={handleCopyMarkdown}
            className="flex-1 p-2 rounded bg-slate-700 border border-slate-600 hover:bg-slate-600 text-xs font-semibold text-white transition-colors"
          >
            Copy MD
          </button>
          {customizedSolutions.length > 0 && (
            <button
              onClick={() => setShowCodeSolution(true)}
              className="flex-[2] p-2 rounded bg-teal-600 hover:bg-teal-700 text-white text-xs font-semibold flex items-center justify-center gap-2"
            >
              {"<View Code Fix />"}
            </button>
          )}
        </div>

      </main>

      <footer className="flex-shrink-0 flex items-center justify-between pt-2 border-t border-slate-700">
        <button onClick={handlePrevious} disabled={currentIndex === 0} className="w-auto p-2 rounded-md disabled:opacity-25 hover:enabled:bg-slate-700">
          ðŸ¡„ Prev
        </button>
        <span className="text-xs font-medium">{currentIndex + 1} / {alerts.length}</span>
        <button onClick={handleNext} disabled={currentIndex === alerts.length - 1} className="w-auto p-2 rounded-md disabled:opacity-25 hover:enabled:bg-slate-700">
          Next ðŸ¡†
        </button>
      </footer>
    </div>
  );
};