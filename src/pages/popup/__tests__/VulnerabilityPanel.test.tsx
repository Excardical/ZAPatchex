import { describe, it, expect, vi, beforeEach } from 'vitest';
import React from 'react';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { VulnerabilityPanel } from '../VulnerabilityPanel';
import * as ZapApi from '@utils/zapApi';

vi.mock('../../utils/zapApi', () => ({
    getSites: vi.fn(),
}));

vi.mock('webextension-polyfill');

// Mock child to avoid complexity
vi.mock('../CodeSolutionPanel', () => ({
    CodeSolutionPanel: ({ onBack }: any) => (
        <div data-testid="code-panel">
            <button onClick={onBack}>Back to Vulns</button>
        </div>
    )
}));

describe('VulnerabilityPanel Component', () => {
    const mockAlerts = [
        {
            name: 'SQL Injection',
            risk: 'High',
            confidence: 'High',
            description: 'SQLi Desc',
            solution: 'Fix SQL',
            instances: [{ url: 'http://site.com/id=1', param: 'id', evidence: 'UNION' }]
        },
        {
            name: 'XSS',
            risk: 'Medium',
            confidence: 'Medium',
            description: 'XSS Desc',
            solution: 'Escape Output',
            instances: [{ url: 'http://site.com/q=alert', param: 'q', evidence: '<script>' }]
        }
    ] as any[];

    const defaultProps = {
        alerts: mockAlerts,
        onBackToScanner: vi.fn(),
        onViewDashboard: vi.fn(),
        host: 'http://localhost',
        apiKey: '123',
        selectedSite: '',
        onSiteSelect: vi.fn(),
    };

    beforeEach(() => {
        vi.clearAllMocks();
        (ZapApi.getSites as any).mockResolvedValue(['http://site.com']);
        global.fetch = vi.fn().mockResolvedValue({
            json: async () => ([])
        });
    });

    it('TC-VULN-01: Renders first alert details correctly', () => {
        render(<VulnerabilityPanel {...defaultProps} />);

        expect(screen.getByText('SQL Injection')).toBeInTheDocument();

        // There are multiple "High" (Risk label, Confidence label), so getAllByText
        const highLabels = screen.getAllByText('High');
        expect(highLabels.length).toBeGreaterThan(0);

        expect(screen.getByText('1 / 2')).toBeInTheDocument();
    });

    it('TC-VULN-02: Pagination (Next/Prev) works', () => {
        render(<VulnerabilityPanel {...defaultProps} />);

        const nextBtn = screen.getByText(/Next/i);
        fireEvent.click(nextBtn);

        expect(screen.getByText('XSS')).toBeInTheDocument();

        const medLabels = screen.getAllByText('Medium');
        expect(medLabels.length).toBeGreaterThan(0);

        expect(screen.getByText('2 / 2')).toBeInTheDocument();

        const prevBtn = screen.getByText(/Prev/i);
        fireEvent.click(prevBtn);
        expect(screen.getByText('SQL Injection')).toBeInTheDocument();
    });

    it('TC-VULN-04: "No Results" state handles empty alerts', () => {
        render(<VulnerabilityPanel {...defaultProps} alerts={[]} />);
        expect(screen.getByText('No Results for this Filter')).toBeInTheDocument();
    });

    it('TC-VULN-05: Site Selection Filter updates parent', async () => {
        render(<VulnerabilityPanel {...defaultProps} />);

        // Wait for site list to populate
        await waitFor(() => expect(screen.getByText('http://site.com')).toBeInTheDocument());

        const select = screen.getByRole('combobox');
        fireEvent.change(select, { target: { value: 'http://site.com' } });

        expect(defaultProps.onSiteSelect).toHaveBeenCalledWith('http://site.com');
    });
});